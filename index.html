<!DOCTYPE html>
<html>
<head>
  <title>ult & co v2.0 website testing</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #000;
    }

    /* The container holds the iframe and the fade overlay */
    .scaled-iframe-container {
      position: relative; /* Required for positioning the overlay */
      width: 400px;
      height: 480px;
      transform-origin: top left;
    }

    .scaled-iframe-container iframe {
      width: 100%;
      height: 100%;
      border: none;
      vertical-align: top; /* Fixes potential small gap below iframe */
    }

    /* CSS for the fade overlay */
    #fadeOverlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #000;
      opacity: 0;
      /* When transparent, it won't intercept mouse clicks */
      pointer-events: none;
      /* The speed of the fade effect */
      transition: opacity 0.4s ease-in-out;
      /* Ensures it's on top of the iframe */
      z-index: 10;
    }

    /* This class is added by JavaScript to trigger the fade */
    #fadeOverlay.visible {
      opacity: 1;
      pointer-events: auto; /* When visible, it blocks clicks */
    }
  </style>
</head>
<body>
  <div class="scaled-iframe-container" id="screenContent">
    <iframe id="appFrame" src="content/apps/homeScreen/homeScreen.html" width="400" height="480"></iframe>
    <div id="fadeOverlay"></div>
  </div>

<script>
    // --- Resize & Zoom Logic ---
    function updateZoomScale() {
      const vh = window.innerHeight;
      const zoomLevel = vh / 480;
      const screenContent = document.getElementById('screenContent');
      if (screenContent) {
        screenContent.style.zoom = zoomLevel;
      }
    }
    
    updateZoomScale();
    window.addEventListener('resize', updateZoomScale);

    // --- Message Listener with Visual and Audio Fade Logic ---
    window.addEventListener('message', (event) => {
        // For security, you should check the origin in a production environment
        // if (event.origin !== 'https://your-trusted-domain.com') return;

        const messageData = event.data;

        // Check for the message to launch a new app
        if (messageData && messageData.type === 'launchApp') {
            
            // Send a message *back* to the current iframe to request an audio fade-out
            if (event.source) {
                event.source.postMessage({ type: 'requestAudioFade' }, event.origin);
            }

            const newLocation = messageData.location;
            const appFrame = document.getElementById('appFrame');
            const overlay = document.getElementById('fadeOverlay');

            // Prevent stacking fades or reloading the same page
            if (overlay.classList.contains('visible') || appFrame.src.endsWith(newLocation)) {
                return;
            }

            // 1. Start the visual fade-to-black
            overlay.classList.add('visible');

            // 2. Wait for the fade animation to complete
            overlay.addEventListener('transitionend', function handleTransition() {
                // 3. Once the screen is black, change the iframe content
                console.log(`Screen faded. Changing source to: ${newLocation}`);
                appFrame.src = newLocation;
                
                // 4. Wait for the new iframe page to fully load
                appFrame.onload = () => {
                    // 5. Fade the screen back in to reveal the new content
                    console.log('New content loaded. Fading in.');
                    overlay.classList.remove('visible');
                    // Clean up the onload handler
                    appFrame.onload = null;
                };

                // Clean up this listener so it only runs once per action
                overlay.removeEventListener('transitionend', handleTransition);
            });
        }
    });
</script>
</body>
</html>